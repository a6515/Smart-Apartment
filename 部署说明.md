# 智慧公寓管理系统 - 部署说明

## 一、环境准备

### 1.1 软件环境要求
- **JDK**: 17 或更高版本
- **Maven**: 3.6 或更高版本
- **MySQL**: 8.0 或更高版本
- **Redis**: 5.0 或更高版本
- **IDE**: IntelliJ IDEA / Eclipse（可选）

### 1.2 检查环境
```bash
# 检查Java版本
java -version

# 检查Maven版本
mvn -version

# 检查MySQL版本
mysql --version

# 检查Redis版本
redis-server --version
```

## 二、数据库部署

### 2.1 启动MySQL服务
```bash
# Windows
net start mysql

# Linux/Mac
sudo systemctl start mysql
# 或
sudo service mysql start
```

### 2.2 创建数据库
```bash
# 登录MySQL
mysql -u root -p

# 执行建表脚本
mysql> source D:/Java-project/SmartApartment/sql/smart_apartment.sql
# 或在MySQL客户端中执行
mysql> CREATE DATABASE IF NOT EXISTS smart_apartment DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
mysql> USE smart_apartment;
mysql> source /path/to/smart_apartment.sql
```

### 2.3 验证数据库
```sql
-- 查看所有表
SHOW TABLES;

-- 查看用户数据
SELECT * FROM sys_user;

-- 默认管理员账号
-- 用户名: admin
-- 密码: admin123
```

## 三、Redis部署

### 3.1 启动Redis服务
```bash
# Windows
redis-server.exe

# Linux/Mac
redis-server
# 或后台启动
redis-server --daemonize yes
```

### 3.2 验证Redis连接
```bash
# 连接Redis
redis-cli

# 测试连接
127.0.0.1:6379> PING
PONG

# 查看所有键
127.0.0.1:6379> KEYS *
```

## 四、后端项目部署

### 4.1 修改配置文件
编辑 `src/main/resources/application.properties`：

```properties
# 服务器端口
server.port=8080

# 数据库配置（请根据实际情况修改）
spring.datasource.url=jdbc:mysql://localhost:3306/smart_apartment?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=your_password

# Redis配置（请根据实际情况修改）
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.password=
spring.redis.database=0
```

### 4.2 编译打包

#### 方式一：Maven命令行
```bash
# 进入项目根目录
cd D:/Java-project/SmartApartment

# 清理并打包
mvn clean package -DskipTests

# 打包完成后，jar包位于 target/ 目录下
```

#### 方式二：IDE打包
- **IntelliJ IDEA**:
  1. 打开右侧 Maven 面板
  2. 展开 Lifecycle
  3. 双击 clean，然后双击 package

### 4.3 启动应用

#### 方式一：直接运行
```bash
# 开发环境运行
mvn spring-boot:run
```

#### 方式二：JAR包运行
```bash
# 运行打包后的jar
java -jar target/SmartApartment-0.0.1-SNAPSHOT.jar

# 指定配置文件运行
java -jar target/SmartApartment-0.0.1-SNAPSHOT.jar --spring.config.location=application.properties

# 后台运行（Linux）
nohup java -jar target/SmartApartment-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
```

### 4.4 验证启动
启动成功后，控制台会显示：
```
Started SmartApartmentApplication in X.XXX seconds
```

访问以下地址验证：
- **API文档**: http://localhost:8080/doc.html
- **健康检查**: http://localhost:8080/actuator/health（需添加actuator依赖）

## 五、接口测试

### 5.1 使用Knife4j在线测试
1. 浏览器访问：http://localhost:8080/doc.html
2. 点击"认证管理"
3. 测试登录接口 `/api/auth/login`
4. 请求参数：
```json
{
  "username": "admin",
  "password": "admin123"
}
```

### 5.2 使用Postman测试

#### 登录接口
```
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

#### 查询楼宇列表
```
GET http://localhost:8080/api/building/page?current=1&size=10
```

## 六、生产环境部署

### 6.1 修改生产环境配置
创建 `application-prod.properties`：
```properties
# 生产环境端口
server.port=8080

# 生产数据库配置
spring.datasource.url=jdbc:mysql://prod-db-host:3306/smart_apartment
spring.datasource.username=prod_user
spring.datasource.password=prod_password

# 生产Redis配置
spring.redis.host=prod-redis-host
spring.redis.port=6379
spring.redis.password=prod_redis_password

# 关闭Swagger（生产环境）
knife4j.enable=false
springdoc.api-docs.enabled=false

# 日志配置
logging.level.root=WARN
logging.level.org.smartapartment=INFO
logging.file.path=/var/log/smartapartment
```

### 6.2 使用Docker部署（推荐）

#### 创建Dockerfile
```dockerfile
FROM openjdk:17-jdk-slim
VOLUME /tmp
COPY target/SmartApartment-0.0.1-SNAPSHOT.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

#### 构建镜像
```bash
docker build -t smartapartment:latest .
```

#### 运行容器
```bash
docker run -d \
  --name smartapartment \
  -p 8080:8080 \
  -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/smart_apartment \
  -e SPRING_DATASOURCE_USERNAME=root \
  -e SPRING_DATASOURCE_PASSWORD=password \
  -e SPRING_REDIS_HOST=host.docker.internal \
  smartapartment:latest
```

### 6.3 使用Nginx反向代理
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location / {
        root /var/www/smartapartment/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

## 七、常见问题排查

### 7.1 数据库连接失败
```
错误信息: Communications link failure
解决方案:
1. 检查MySQL服务是否启动
2. 检查数据库地址、端口、用户名、密码是否正确
3. 检查防火墙是否开放3306端口
4. 确认MySQL允许远程连接
```

### 7.2 Redis连接失败
```
错误信息: Unable to connect to Redis
解决方案:
1. 检查Redis服务是否启动
2. 检查Redis配置是否正确
3. 如有密码，确认密码配置正确
4. 检查防火墙是否开放6379端口
```

### 7.3 端口占用
```
错误信息: Port 8080 was already in use
解决方案:
1. 修改application.properties中的server.port
2. 或停止占用8080端口的程序
   Windows: netstat -ano | findstr 8080
   Linux: lsof -i:8080
```

### 7.4 依赖下载失败
```
解决方案:
1. 配置Maven国内镜像源（阿里云）
2. 编辑 settings.xml，添加：
<mirror>
  <id>aliyun</id>
  <mirrorOf>central</mirrorOf>
  <name>Aliyun Maven</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>
```

## 八、性能优化建议

### 8.1 JVM参数调优
```bash
java -Xms512m -Xmx1024m -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -jar SmartApartment-0.0.1-SNAPSHOT.jar
```

### 8.2 数据库优化
- 建立索引（已在SQL脚本中配置）
- 定期清理日志表数据
- 配置MySQL连接池参数

### 8.3 Redis优化
- 设置合理的缓存过期时间
- 使用Redis持久化策略
- 配置Redis最大内存限制

## 九、监控与日志

### 9.1 查看应用日志
```bash
# 实时查看日志
tail -f app.log

# 查看错误日志
grep "ERROR" app.log

# 查看最近100行日志
tail -n 100 app.log
```

### 9.2 系统监控
建议集成以下监控工具：
- **Spring Boot Actuator** - 应用健康检查
- **Prometheus + Grafana** - 性能监控
- **ELK Stack** - 日志分析

## 十、备份与恢复

### 10.1 数据库备份
```bash
# 备份数据库
mysqldump -u root -p smart_apartment > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u root -p smart_apartment < backup_20241124.sql
```

### 10.2 Redis备份
```bash
# Redis会自动生成dump.rdb文件
# 备份该文件即可
cp /var/lib/redis/dump.rdb /backup/redis_backup_$(date +%Y%m%d).rdb
```

## 联系支持

如遇到部署问题，请联系：
- 邮箱：your-email@example.com
- 项目地址：https://github.com/your-repo/SmartApartment
