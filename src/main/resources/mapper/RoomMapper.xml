<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.smartapartment.smartapartment.mapper.RoomMapper">

    <!-- BaseResultMap定义 -->
    <resultMap id="BaseResultMap" type="org.smartapartment.smartapartment.entity.Room">
        <id column="id" property="id"/>
        <result column="buildingId" property="buildingId"/>
        <result column="buildingName" property="buildingName"/>
        <result column="roomNumber" property="roomNumber"/>
        <result column="floor" property="floor"/>
        <result column="roomType" property="roomType"/>
        <result column="totalBeds" property="totalBeds"/>
        <result column="availableBeds" property="availableBeds"/>
        <result column="area" property="area"/>
        <result column="price" property="price"/>
        <result column="facilities" property="facilities"/>
        <result column="roomStatus" property="roomStatus"/>
        <result column="description" property="description"/>
        <result column="deleted" property="deleted"/>
        <result column="createTime" property="createTime"/>
        <result column="updateTime" property="updateTime"/>
    </resultMap>

    <select id="selectPage" resultType="org.smartapartment.smartapartment.entity.Room">
        select
            r.id,
            r.building_id as buildingId,
            b.building_name as buildingName,
            r.room_number as roomNumber,
            r.floor,
            r.room_type as roomType,
            r.total_beds as totalBeds,
            r.available_beds as availableBeds,
            r.area,
            r.price,
            r.facilities,
            r.room_status as roomStatus,
            r.description,
            r.deleted,
            r.create_time as createTime,
            r.update_time as updateTime
        from
            room r
        left join
            building b on r.building_id = b.id
        <where>
            r.deleted = 0
            <if test="buildingId != null and buildingId != ''">
                and r.building_id = #{buildingId}
            </if>
            <if test="roomNumber != null and roomNumber != ''">
                and r.room_number like concat('%', #{roomNumber}, '%')
            </if>
            <if test="roomStatus != null and roomStatus != ''">
                and r.room_status = #{roomStatus}
            </if>
        </where>
        order by r.create_time desc
    </select>

    <select id="selectAvailableRooms" resultType="org.smartapartment.smartapartment.entity.Room">
        <!-- SQL查询开始：这个查询支持按楼栋ID、房型、楼层和床位状态进行筛选 -->
        <!-- 参数调试：#{buildingId}, #{roomType}, #{floorNumber}, #{hasAvailableBeds} -->
        select
            r.id,
            r.building_id as buildingId,
            b.building_name as buildingName,
            r.room_number as roomNumber,
            r.floor,
            r.room_type as roomType,
            r.total_beds as totalBeds,
            r.available_beds as availableBeds,
            r.area,
            r.price,
            r.facilities,
            r.room_status as roomStatus,
            r.description,
            r.deleted,
            r.create_time as createTime,
            r.update_time as updateTime
        from
            room r
        left join
            building b on r.building_id = b.id
        <where>
            r.deleted = 0
            <if test="hasAvailableBeds != null">
                <choose>
                    <when test="hasAvailableBeds == true">
                        and r.available_beds > 0
                    </when>
                    <otherwise>
                        and r.available_beds = 0
                    </otherwise>
                </choose>
            </if>
            <if test="buildingId != null">
                and r.building_id = #{buildingId}
            </if>
            <if test="roomType != null">
                and r.room_type = #{roomType}
            </if>
            <if test="floorNumber != null and floorNumber != ''">
                <!-- 楼层筛选，确保数据类型匹配且非空字符串 -->
                and r.floor = #{floorNumber}
            </if>
        </where>
        order by b.building_name, r.room_number
        <!-- SQL查询结束 -->
    </select>

    <select id="selectById" resultType="org.smartapartment.smartapartment.entity.Room">
        SELECT 
            r.id,
            r.building_id as buildingId,
            b.building_name as buildingName,
            r.room_number as roomNumber,
            r.floor,
            r.room_type as roomType,
            r.total_beds as totalBeds,
            r.available_beds as availableBeds,
            r.area,
            r.price,
            r.facilities,
            r.room_status as roomStatus,
            r.description,
            r.deleted,
            r.create_time as createTime,
            r.update_time as updateTime
        FROM room r
        LEFT JOIN building b ON r.building_id = b.id
        WHERE r.id = #{id} AND r.deleted = 0
    </select>

    <insert id="insert" parameterType="org.smartapartment.smartapartment.entity.Room"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO room (
            building_id,
            floor,
            room_number,
            room_type,
            total_beds,
            available_beds,
            room_status,
            create_time,
            update_time,
            deleted
        ) VALUES (
            #{buildingId},
            #{floor},
            #{roomNumber},
            #{roomType},
            #{totalBeds},
            #{availableBeds},
            #{roomStatus},
            NOW(),
            NOW(),
            0
        )
    </insert>

    <update id="updateById">
        UPDATE room
        SET building_id = #{buildingId},
            floor = #{floor},
            room_number = #{roomNumber},
            room_type = #{roomType},
            total_beds = #{totalBeds},
            available_beds = #{availableBeds},
            room_status = #{roomStatus},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <update id="deleteById">
        UPDATE room
        SET deleted = 1, update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 按楼栋ID查询所有房间 -->
    <select id="selectByBuildingId" resultType="org.smartapartment.smartapartment.entity.Room">
        select r.id, r.building_id as buildingId, b.building_name as buildingName, r.room_number as roomNumber, 
               r.floor, r.room_type as roomType, r.total_beds as totalBeds, r.available_beds as availableBeds,
               r.area, r.price, r.facilities, r.room_status as roomStatus, r.description, r.deleted,
               r.create_time as createTime, r.update_time as updateTime
        from room r
        left join building b on r.building_id = b.id
        where r.deleted = 0 and r.building_id = #{buildingId}
        order by r.floor, r.room_number
    </select>

    <!-- 统计房间总数 -->
    <select id="countTotal" resultType="java.lang.Long">
        SELECT COUNT(*) FROM room WHERE deleted = 0
    </select>
    
    <!-- 统计各状态房间数量 -->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*) FROM room 
        WHERE deleted = 0 AND room_status = #{status}
    </select>
    
    <!-- 统计总床位数 -->
    <select id="countTotalBeds" resultType="java.lang.Long">
        SELECT IFNULL(SUM(total_beds), 0) FROM room WHERE deleted = 0
    </select>
    
    <!-- 统计剩余床位数 -->
    <select id="countAvailableBeds" resultType="java.lang.Long">
        SELECT IFNULL(SUM(available_beds), 0) FROM room WHERE deleted = 0
    </select>

</mapper>
